import{_ as s,c as a,e as t,d as e}from"./app-yBO_JKoh.js";const p={};function i(c,n){return e(),a("div",null,n[0]||(n[0]=[t(`<h1 id="rate-limiting" tabindex="-1"><a class="header-anchor" href="#rate-limiting"><span>Rate Limiting</span></a></h1><p>Волга предоставляет встроенную высокопроизводительную систему ограничения скорости запросов, разработанную для HTTP API и микросервисов. Она поддерживает несколько алгоритмов, гибкие partition keys и может применяться глобально, для каждой группы маршрутов или для каждого маршрута отдельно.</p><p>В этом руководстве демонстрируется базовое использование алгоритма <strong>Фиксированного окна</strong>.</p><h2 id="включение-rate-limiting" tabindex="-1"><a class="header-anchor" href="#включение-rate-limiting"><span>Включение Rate Limiting</span></a></h2><p>Rate Limiting - это дополнительная функция.</p><p>Ее необходимо включить явно в <code>Cargo.toml</code>:</p><div class="language-toml line-numbers-mode" data-highlighter="prismjs" data-ext="toml"><pre><code class="language-toml"><span class="line"><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token key property">volga</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;rate-limiting&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Или включите набор функций <code>full</code>:</p><div class="language-toml line-numbers-mode" data-highlighter="prismjs" data-ext="toml"><pre><code class="language-toml"><span class="line"><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token key property">volga</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;full&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="основные-концепции" tabindex="-1"><a class="header-anchor" href="#основные-концепции"><span>Основные Концепции</span></a></h2><p>Прежде чем перейти к примерам, полезно понять основные составляющие:</p><h3 id="политика-rate-limiting" tabindex="-1"><a class="header-anchor" href="#политика-rate-limiting"><span>Политика Rate Limiting</span></a></h3><p>Политика определяет:</p><ul><li>Алгоритм ограничения скорости запросов (например, фиксированное окно)</li><li>Максимальное количество запросов</li><li>Длительность окна</li><li>Опциональное поведение вытеснения</li><li>Опциональное имя</li></ul><p>Политики настраиваются один раз на уровне приложения.</p><h3 id="partition-key" tabindex="-1"><a class="header-anchor" href="#partition-key"><span>Partition Key</span></a></h3><p><strong>Partition key</strong> определяет, как группируются запросы.</p><p>Типичные примеры:</p><ul><li>IP-адрес клиента</li><li>Аутентифицированный пользователь</li><li>Ключ API</li><li>Параметр запроса или пути</li></ul><p>Волга предоставляет вспомогательные функции в рамках <code>volga::rate_limiting::by</code>.</p><h3 id="где-можно-применять-rate-limiting" tabindex="-1"><a class="header-anchor" href="#где-можно-применять-rate-limiting"><span>Где можно применять Rate Limiting</span></a></h3><p>Middleware для rate limiting может быть подключено:</p><ul><li>Глобально (ко всему приложению)</li><li>Группе маршрутов</li><li>Отдельному маршруту</li></ul><h2 id="определение-политики-фиксированного-окна" tabindex="-1"><a class="header-anchor" href="#определение-политики-фиксированного-окна"><span>Определение политики фиксированного окна</span></a></h2><p>Rate Limiter с фиксированным окном разрешает до <em>N запросов за временное окно</em>.</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code class="language-rust"><span class="line"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token namespace">volga<span class="token punctuation">::</span>rate_limiting<span class="token punctuation">::</span></span><span class="token class-name">FixedWindow</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> fixed_window <span class="token operator">=</span> <span class="token class-name">FixedWindow</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Эта политика разрешает <strong>100 запросов за 30 секунд</strong>.</p><h3 id="именованные-политики" tabindex="-1"><a class="header-anchor" href="#именованные-политики"><span>Именованные политики</span></a></h3><p>Политики могут быть именованы и использованы повторно:</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code class="language-rust"><span class="line"><span class="token keyword">let</span> burst <span class="token operator">=</span> <span class="token class-name">FixedWindow</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">with_name</span><span class="token punctuation">(</span><span class="token string">&quot;burst&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Именованные политики полезны, когда разные маршруты требуют разных ограничений.</p><h2 id="регистрация-политики" tabindex="-1"><a class="header-anchor" href="#регистрация-политики"><span>Регистрация политики</span></a></h2><p>Политики регистрируются в приложении:</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code class="language-rust"><span class="line"><span class="token keyword">use</span> <span class="token namespace">volga<span class="token punctuation">::</span></span><span class="token class-name">App</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> <span class="token keyword">mut</span> app <span class="token operator">=</span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">with_fixed_window</span><span class="token punctuation">(</span>burst<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>На этом этапе политика существует, но еще не активна.</p><h2 id="применение-rate-limiting" tabindex="-1"><a class="header-anchor" href="#применение-rate-limiting"><span>Применение Rate Limiting</span></a></h2><h3 id="глобальныи-rate-limiting" tabindex="-1"><a class="header-anchor" href="#глобальныи-rate-limiting"><span>Глобальный Rate Limiting</span></a></h3><p>Применить rate limiting ко всем входящим запросам можно вот так:</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code class="language-rust"><span class="line"><span class="token keyword">use</span> <span class="token namespace">volga<span class="token punctuation">::</span>rate_limiting<span class="token punctuation">::</span></span>by<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use_fixed_window</span><span class="token punctuation">(</span><span class="token namespace">by<span class="token punctuation">::</span></span><span class="token function">ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Это ограничивает все запросы на основе IP-адреса клиента.</p><h3 id="использование-именованных-политик" tabindex="-1"><a class="header-anchor" href="#использование-именованных-политик"><span>Использование именованных политик</span></a></h3><p>Вот так можно использовать конкретную именованную политику:</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code class="language-rust"><span class="line">app<span class="token punctuation">.</span><span class="token function">use_fixed_window</span><span class="token punctuation">(</span><span class="token namespace">by<span class="token punctuation">::</span></span><span class="token function">ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">using</span><span class="token punctuation">(</span><span class="token string">&quot;burst&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="route-level-rate-limiting" tabindex="-1"><a class="header-anchor" href="#route-level-rate-limiting"><span>Route-Level Rate Limiting</span></a></h3><p>Rate limiting можно применять и к отдельным маршрутам:</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code class="language-rust"><span class="line">app<span class="token punctuation">.</span><span class="token function">map_get</span><span class="token punctuation">(</span><span class="token string">&quot;/upload&quot;</span><span class="token punctuation">,</span> upload_handler<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">fixed_window</span><span class="token punctuation">(</span><span class="token namespace">by<span class="token punctuation">::</span></span><span class="token function">ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Или с помощью именованной политики:</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code class="language-rust"><span class="line">app<span class="token punctuation">.</span><span class="token function">map_get</span><span class="token punctuation">(</span><span class="token string">&quot;/upload&quot;</span><span class="token punctuation">,</span> upload_handler<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">fixed_window</span><span class="token punctuation">(</span><span class="token namespace">by<span class="token punctuation">::</span></span><span class="token function">ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">using</span><span class="token punctuation">(</span><span class="token string">&quot;burst&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="rate-limiting-для-групп-маршрутов" tabindex="-1"><a class="header-anchor" href="#rate-limiting-для-групп-маршрутов"><span>Rate Limiting для групп маршрутов</span></a></h3><p>Rate Limiting также может применяться к группе маршрутов:</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code class="language-rust"><span class="line">app<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&quot;/api&quot;</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>api<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span></span>
<span class="line">    api<span class="token punctuation">.</span><span class="token function">fixed_window</span><span class="token punctuation">(</span><span class="token namespace">by<span class="token punctuation">::</span></span><span class="token function">ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    api<span class="token punctuation">.</span><span class="token function">map_get</span><span class="token punctuation">(</span><span class="token string">&quot;/status&quot;</span><span class="token punctuation">,</span> status_handler<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    api<span class="token punctuation">.</span><span class="token function">map_post</span><span class="token punctuation">(</span><span class="token string">&quot;/upload&quot;</span><span class="token punctuation">,</span> upload_handler<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="примеры-partition-key" tabindex="-1"><a class="header-anchor" href="#примеры-partition-key"><span>Примеры Partition Key</span></a></h2><p>Волга предоставляет встроенные вспомогательные функции:</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code class="language-rust"><span class="line"><span class="token namespace">by<span class="token punctuation">::</span></span><span class="token function">ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">// IP-адрес клиента</span></span>
<span class="line"><span class="token namespace">by<span class="token punctuation">::</span></span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;x-api-key&quot;</span><span class="token punctuation">)</span> <span class="token comment">// Пользовательский HTTP-заголовок</span></span>
<span class="line"><span class="token namespace">by<span class="token punctuation">::</span></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;tenant_id&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// Параметр запроса</span></span>
<span class="line"><span class="token namespace">by<span class="token punctuation">::</span></span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">)</span>     <span class="token comment">// Параметр пути</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>При включенной функции аутентификации:</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code class="language-rust"><span class="line"><span class="token namespace">by<span class="token punctuation">::</span></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>claims<span class="token closure-punctuation punctuation">|</span></span> claims<span class="token punctuation">.</span>sub<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Вы также можете комбинировать несколько ключей, используя слои middleware.</p><h2 id="прочие-алгоритмы" tabindex="-1"><a class="header-anchor" href="#прочие-алгоритмы"><span>Прочие алгоритмы</span></a></h2><p>В дополнение к <strong>Фиксированному окну</strong>, Волга поддерживает:</p><ul><li><strong>Скользящее окно</strong> – более плавное распределение запросов</li><li>(Планируется добавление других алгоритмов)</li></ul><p>Шаблон использования остается тем же:</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code class="language-rust"><span class="line"><span class="token punctuation">.</span><span class="token function">with_sliding_window</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">.</span><span class="token function">sliding_window</span><span class="token punctuation">(</span><span class="token namespace">by<span class="token punctuation">::</span></span><span class="token function">ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Полный пример можно посмотреть <a href="https://github.com/RomanEmreis/volga/blob/main/examples/rate_limiting/src/main.rs" target="_blank" rel="noopener noreferrer">здесь</a>.</p>`,63)]))}const o=s(p,[["render",i]]),u=JSON.parse('{"path":"/ru/middleware-infrastructure/rate-limiting.html","title":"Rate Limiting","lang":"ru-RU","frontmatter":{},"git":{"updatedTime":1768761219000,"contributors":[{"name":"Roman Emreis","username":"","email":"r.emreis@outlook.com","commits":1},{"name":"RomanEmreis","username":"RomanEmreis","email":"39233213+RomanEmreis@users.noreply.github.com","commits":1,"url":"https://github.com/RomanEmreis"}],"changelog":[{"hash":"53a947230481769d7454b5a9793d12bc5f150247","time":1768761219000,"email":"39233213+RomanEmreis@users.noreply.github.com","author":"Roman","message":"Reorganize docs sidebar and move SSE to protocols (#6)"},{"hash":"c1efb6574d93d5b386148e5d89de673f79228db1","time":1768749966000,"email":"r.emreis@outlook.com","author":"Roman Emreis","message":"new release"}]},"filePathRelative":"ru/middleware-infrastructure/rate-limiting.md"}');export{o as comp,u as data};
